## We filter out low confidence LARRY reads and assign LARRY BC ## 
library(Seurat)
library(ggplot2)
library(dplyr)
library(Matrix)


base_dir <- "C:/Users/s208205/Downloads/R_projects/MetTag_BC_OVA"
figures_dir <- file.path(base_dir, "L1_Figures")

# load L1 singlet seurat data 

L1.singlet <- readRDS("./DATA/RDS/L1.singlet.rds")

# 3 sparse LARRY matrix and 2 Lib_ID files generated by  "05_CountUMI_sparseMtx.py" 
## Define file paths. c2b2l4 indicate HM setting for cellBC(2), lib_ID(2), LARRY(4)
Cell_barcodes_file <- "./DATA/Direct_LARRY/L1/c_post_larry_c2b2l4_N_barcodes.tsv"
LARRY_matrix_file <- "./DATA/Direct_LARRY/L1/c_post_larry_c2b2l4_N.mtx"
LARRY_BC_features_file <- "./DATA/Direct_LARRY/L1/c_post_larry_c2b2l4_N_features.tsv"
Lib_ID_matrix <- "./DATA/Direct_LARRY/L1/c_post_larry_c2b2l4_N_lib.mtx"
Lib_ID_barcodes_file <- "./DATA/Direct_LARRY/L1/c_post_larry_c2b2l4_N_lib_id_barcode.tsv"


# Read the cell barcodes and LARRY and Lib_ID barcodes
cell_barcodes <- read.delim(Cell_barcodes_file, header = FALSE, stringsAsFactors = FALSE)[, 1]
cell_barcodes <- paste0(cell_barcodes, "-1")
LARRY_barcodes <- read.delim(LARRY_BC_features_file, header = FALSE, stringsAsFactors = FALSE)[, 1]
Lib_ID_barcodes <- read.delim(Lib_ID_barcodes_file, header = FALSE, stringsAsFactors = FALSE)[, 1]

# Assign row and column names to the sparse matrices
LARRY_sparse_matrix <- readMM(LARRY_matrix_file)
dim(LARRY_sparse_matrix)
rownames(LARRY_sparse_matrix) <- cell_barcodes
colnames(LARRY_sparse_matrix) <- LARRY_barcodes
LARRY_sparse_matrix <- t(LARRY_sparse_matrix)
dim(LARRY_sparse_matrix)
LARRY_sparse_matrix[1:6,1:5]

# Filter low abundance LARRY 
LARRY_sparse_matrix <- LARRY_sparse_matrix[(which((rowSums(LARRY_sparse_matrix)) >= 10)),]
dim(LARRY_sparse_matrix)
LARRY_sparse_matrix[1:6,1:5]

# Read Lib_Id matrix
Lib_ID_sparse_matrix <- readMM(Lib_ID_matrix)
dim(Lib_ID_sparse_matrix)
rownames(Lib_ID_sparse_matrix) <- cell_barcodes
colnames(Lib_ID_sparse_matrix) <- Lib_ID_barcodes
Lib_ID_sparse_matrix <- t(Lib_ID_sparse_matrix)
dim(Lib_ID_sparse_matrix)
Lib_ID_sparse_matrix[1:6,1:5]

# Define the Lib_ID mapping
barcode_mapping <- list(
  ATCACG = "R1_BC_ID1",
  TTAGGC = "R1_BC_ID2",
  CGATGT = "R1_BC_ID3",
  TGACCA = "R1_BC_ID4",
  GCCAAT = "R1_BC_ID5",
  ACTTGA = "R1_BC_ID6"
)

# Filter low abundance Lib_IDs (mostly likely due to PCR/sequencing errors)
Lib_ID_sparse_matrix <- Lib_ID_sparse_matrix[(which((rowSums(Lib_ID_sparse_matrix)) >= 10)),]
dim(Lib_ID_sparse_matrix)
Lib_ID_sparse_matrix[1:6,1:5]

# Create the Seurat object with the first assay
seurat_obj <- CreateSeuratObject(counts = LARRY_sparse_matrix, assay = "LARRY", project = "LARRY_mtx_L1")

# Add the lib-ID assay to the Seurat object
seurat_obj$Lib_ID <- CreateAssayObject(counts = Lib_ID_sparse_matrix)

# Check obj
seurat_obj
dim(seurat_obj)

meta <- seurat_obj@meta.data
seurat_obj@meta.data$LARRY_ratio <- seurat_obj@meta.data$nCount_LARRY/seurat_obj@meta.data$nFeature_LARRY
seurat_obj@meta.data$Lib_ID_ratio <- seurat_obj@meta.data$nCount_Lib_ID/seurat_obj@meta.data$nFeature_Lib_ID
meta <- seurat_obj@meta.data

# verify seurat obj structure and row col names
head(seurat_obj@meta.data)
head(colnames(seurat_obj@assays$LARRY))
rownames(seurat_obj@meta.data)
head(rownames(seurat_obj@assays$Lib_ID))
head(rownames(seurat_obj@meta.data))


# =========== Assign LARRY and Lib_ID ===============
# established LARRY/Lib_ID assignment obj
L1.LARRY <- subset(seurat_obj, subset = nFeature_LARRY > 0 & nCount_LARRY > 20 & nFeature_Lib_ID > 0 & nCount_Lib_ID > 20) # can tweak the number to change the assignment sensitivity
dim(L1.LARRY)
str(L1.LARRY)

meta.L1.LARRY <- L1.LARRY@meta.data


# Plot scatter plot of LARRY ratio and Lib_ID ratio
pdf(file.path(figures_dir, "L1_LARRY_Lib_ID_Count-Feature_ratio.pdf"),width=8,height=4,paper='special')
max_val <- max(L1.LARRY$nCount_LARRY, L1.LARRY$nFeature_LARRY)
plot1 <- FeatureScatter(L1.LARRY, feature1 = "nCount_LARRY", feature2 = "nFeature_LARRY") +
  coord_cartesian(xlim = c(0, max_val), ylim = c(0, max_val)) + 
  NoLegend() + ggtitle("L1.LARRY") 
max_val_2 <- max(L1.LARRY$nCount_Lib_ID, L1.LARRY$nFeature_Lib_ID)
plot2 <- FeatureScatter(L1.LARRY, feature1 = "nCount_Lib_ID", feature2 = "nFeature_Lib_ID") +
  coord_cartesian(xlim = c(0, max_val_2), ylim = c(0, max_val_2)) + 
  NoLegend() + ggtitle("L1.Lib_ID") 
plot1 + plot2
dev.off()

meta.L1.LARRY <- L1.LARRY@meta.data

# ==== LARRY and Lib_ID assignment by adaptive threshold ==== 

L1.LARRY <- NormalizeData(L1.LARRY, assay = "LARRY", normalization.method = "CLR")
L1.LARRY_counts <- L1.LARRY@assays$LARRY$data
str(L1.LARRY_counts)
dim(L1.LARRY_counts)
L1.LARRY_counts[1:4,1:5]

L1.LARRY <- NormalizeData(L1.LARRY, assay = "Lib_ID", normalization.method = "CLR")
L1.Lib_ID_counts <- L1.LARRY@assays$Lib_ID$data
str(L1.Lib_ID_counts)
dim(L1.Lib_ID_counts)
L1.Lib_ID_counts[1:4,1:5]

#' Assign Cell Barcode Classification with Adaptive Thresholding and Prefix
#'
#' This function classifies cells into singlets, doublets, and multiplets based on their barcode expression counts.
#' An adaptive threshold is used for each cell based on its maximum barcode expression.
#' The function can handle multiple barcode assignments by using a prefix to differentiate between them.
#'
#' @param count_matrix A matrix of expression counts where rows are barcodes and columns are cells.
#' @param base_threshold A numeric value indicating the base threshold for considering significant barcode counts (default is 0.2).
#' @param prefix A character string to be used as a prefix for the output column names to differentiate between different barcode assignments.
#'
#' @return A data frame with row names set to cell names and prefixed columns `first_bc`, `second_bc`, and `bc_classification`.
#'
#' @examples
#' result_Lib_ID <- assign_cell_barcode_classification_adaptive(L1.Lib_ID_counts, base_threshold = 0.2, prefix = "LibID")
#' result_LARRY <- assign_cell_barcode_classification_adaptive(L1.LARRY_counts, base_threshold = 0.2, prefix = "LARRY")
#' head(result_Lib_ID)
#' head(result_LARRY)
#'
assign_cell_barcode_classification_adaptive <- function(count_matrix, base_threshold = 0.2, prefix = "") {
  # Initialize vectors to store the results
  first_bc <- vector("character", ncol(count_matrix))
  second_bc <- vector("character", ncol(count_matrix))
  bc_classification <- vector("character", ncol(count_matrix))
  
  # Loop through each cell (column)
  for (i in seq_len(ncol(count_matrix))) {
    # Get the expression counts for the current cell
    cell_counts <- count_matrix[, i]
    
    # Find the index and value of the maximum expression count
    max_index <- which.max(cell_counts)
    max_value <- cell_counts[max_index]
    
    # Calculate the lower bound for threshold comparison based on the maximum value of the current cell
    lower_bound <- max_value * (1 - base_threshold)
    
    # Find barcodes with counts within the threshold range
    close_to_max <- which(cell_counts >= lower_bound)
    
    # Assign barcodes and classify the cell
    if (length(close_to_max) == 1) {
      # Single barcode
      first_bc[i] <- rownames(count_matrix)[max_index]
      second_bc[i] <- NA
      bc_classification[i] <- "singlet"
    } else if (length(close_to_max) == 2) {
      # Doublet
      first_bc[i] <- rownames(count_matrix)[close_to_max[1]]
      second_bc[i] <- rownames(count_matrix)[close_to_max[2]]
      bc_classification[i] <- "doublet"
    } else {
      # Multilet
      first_bc[i] <- rownames(count_matrix)[close_to_max[1]]
      second_bc[i] <- rownames(count_matrix)[close_to_max[2]]
      bc_classification[i] <- "multilet"
    }
  }
  
  # Create a data frame with prefixed column names and set row names as cell names
  result <- data.frame(first_bc = first_bc, second_bc = second_bc, bc_classification = bc_classification)
  colnames(result) <- paste0(prefix, "_", colnames(result))
  rownames(result) <- colnames(count_matrix)
  
  return(result)
}


# usage with two different count matrices. L1.Lib_ID_counts and L1.LARRY_counts are your input matrices for LibID and LARRY barcodes respectively
result_Lib_ID <- assign_cell_barcode_classification_adaptive(L1.Lib_ID_counts, base_threshold = 0.2, prefix = "LibID")
result_LARRY <- assign_cell_barcode_classification_adaptive(L1.LARRY_counts, base_threshold = 0.2, prefix = "LARRY")

# Combine the results
combined_results <- cbind(result_Lib_ID, result_LARRY)

# Adding metadata to Seurat object
L1.LARRY <- AddMetaData(L1.LARRY, combined_results)
head(combined_results)

# View the updated metadata
head(L1.LARRY@meta.data)
meta.L1.LARRY <- L1.LARRY@meta.data

# Recode LARRY anno: Replace NA or "Negative" or C/F ratio < 2 in the first bc column with "Not detected"

meta.L1.LARRY <- meta.L1.LARRY %>%
  mutate(LARRY_first_bc = if_else(LARRY_ratio < 2, "LARRY_ratio_less_2", LARRY_first_bc))
meta.L1.LARRY <- meta.L1.LARRY %>%
  mutate(LARRY_second_bc = if_else(LARRY_ratio < 2, "LARRY_ratio_less_2", LARRY_second_bc))

meta.L1.LARRY$LARRY_first_bc[is.na(meta.L1.LARRY$LARRY_first_bc)] <- "not_detected"
meta.L1.LARRY$LARRY_second_bc[is.na(meta.L1.LARRY$LARRY_second_bc)] <- "not_detected"
meta.L1.LARRY$LARRY_bc_classification[is.na(meta.L1.LARRY$LARRY_first_bc)] <- "not_detected"

meta.L1.LARRY$LARRY_first_bc <- as.factor(meta.L1.LARRY$LARRY_first_bc)

# Recode Lib_ID anno: Replace NA or "Negative" or C/F ratio <3 in the first bc column with "Not detected"

meta.L1.LARRY <- meta.L1.LARRY %>%
  mutate(LibID_first_bc = if_else(Lib_ID_ratio < 3, "Lib_ID_ratio_less_3", LibID_first_bc))
meta.L1.LARRY <- meta.L1.LARRY %>%
  mutate(LibID_second_bc = if_else(Lib_ID_ratio < 3, "Lib_ID_ratio_less_3", LibID_second_bc))

meta.L1.LARRY$LibID_first_bc[is.na(meta.L1.LARRY$LibID_first_bc)] <- "not_detected"
meta.L1.LARRY$LibID_second_bc[is.na(meta.L1.LARRY$LibID_second_bc)] <- "not_detected"
meta.L1.LARRY$LibID_bc_classification[is.na(meta.L1.LARRY$LibID_first_bc)] <- "not_detected"

meta.L1.LARRY$LibID_first_bc <- as.factor(meta.L1.LARRY$LibID_first_bc)

# write back to seurat meta
L1.LARRY@meta.data  <- meta.L1.LARRY

# ====== 
# Ensure LibID_first_bc is a character vector
L1.LARRY@meta.data$LibID_first_bc <- as.character(L1.LARRY@meta.data$LibID_first_bc)

# Recode first_bc based on the mapping
L1.LARRY@meta.data$LibID_first_bc <- sapply(L1.LARRY@meta.data$LibID_first_bc, function(bc) {
  if (bc %in% names(barcode_mapping)) {
    return(barcode_mapping[[bc]])
  } else {
    return(bc)
  }
})

# Recode Lib_ID_sparse_matrix
Lib_ID_sparse_matrix[1:6,1:5]

# Extract the row names
row_names <- rownames(Lib_ID_sparse_matrix)

# Recode row names based on the mapping
new_row_names <- sapply(row_names, function(bc) {
  if (bc %in% names(barcode_mapping)) {
    return(barcode_mapping[[bc]])
  } else {
    return(bc)
  }
})

# Assign the new row names to the sparse matrix
rownames(Lib_ID_sparse_matrix) <- new_row_names
Lib_ID_sparse_matrix[1:6,1:5]

# Convert the result back to a factor if needed
L1.LARRY@meta.data$LibID_first_bc <- factor(L1.LARRY@meta.data$LibID_first_bc)

head(L1.LARRY@meta.data$LibID_first_bc)

# Print the table to verify the recoding
table(L1.LARRY@meta.data$LibID_first_bc)


# === plotting LARRY BC freq ===

# check the LARRY freq table
table(L1.LARRY@meta.data$LARRY_first_bc)

# Calculate the frequency table
LARRY_freq_table <- as.data.frame(table(L1.LARRY@meta.data$LARRY_first_bc))

# Sort the frequency table from high to low
sorted_LARRY_freq_table <- LARRY_freq_table %>%
  arrange(desc(Freq))
head(sorted_LARRY_freq_table)

# Remove the rows with 'LARRY_ratio_less_2'
filtered_LARRY_freq_table <- sorted_LARRY_freq_table %>%
  filter(Var1 != "LARRY_ratio_less_2")

# Plot a histogram using ggplot2
ggplot(filtered_LARRY_freq_table, aes(x = reorder(Var1, -Freq), y = Freq)) +
  geom_bar(stat = "identity") +
  xlab("Barcode ID") +
  ylab("Frequency") +
  ggtitle("Frequency of Barcode IDs") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


# subset LARRY singlet obj

Idents(L1.LARRY) <- "LARRY_bc_classification"
L1.LARRY.singlet <- subset(L1.LARRY, idents = "singlet")
meta.L1.LARRY.singlet <- L1.LARRY.singlet@meta.data

# Calculate the frequency table
LARRY_singlet_freq_table <- as.data.frame(table(L1.LARRY.singlet@meta.data$LARRY_first_bc))

# Sort the frequency table from high to low
sorted_LARRY_singlet_freq_table <- LARRY_singlet_freq_table %>%
  arrange(desc(Freq))
head(sorted_LARRY_singlet_freq_table)

# Remove the rows with 'LARRY_ratio_less_2'
filtered_LARRY_singlet_freq_table <- sorted_LARRY_singlet_freq_table %>%
  filter(Var1 != "LARRY_ratio_less_2")

# Plot a histogram using ggplot2
pdf(file.path(figures_dir, "L1_filtered_LARRY_singlet_freq_table.pdf"),width=20,height=5,paper='special')
ggplot(filtered_LARRY_singlet_freq_table, aes(x = reorder(Var1, -Freq), y = Freq)) +
  geom_bar(stat = "identity") +
  xlab("Barcode ID") +
  ylab("Frequency") +
  ggtitle("Frequency of Barcode IDs") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
dev.off()

filtered_LARRY_singlet_freq_table_above2 <- sorted_LARRY_singlet_freq_table %>%
  filter(Var1 != "LARRY_ratio_less_2" & Freq > 2 )

pdf(file.path(figures_dir, "L1_filtered_LARRY_singlet_freqabove2_table.pdf"),width=10,height=5,paper='special')
ggplot(filtered_LARRY_singlet_freq_table_above2, aes(x = reorder(Var1, -Freq), y = Freq)) +
  geom_bar(stat = "identity") +
  xlab("Barcode ID") +
  ylab("Frequency") +
  ggtitle("Frequency of LARRY BC (Freq >2) ") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
dev.off()

# === plotting Lib_BC freq ===

Idents(L1.LARRY) <- "LibID_bc_classification"
L1.Lib_ID.singlet <- subset(L1.LARRY, idents = "singlet")
meta.L1.Lib_ID.singlet <- L1.Lib_ID.singlet@meta.data

# Calculate the frequency table
Lib_ID_singlet_freq_table <- as.data.frame(table(L1.Lib_ID.singlet@meta.data$LibID_first_bc))

# Sort the frequency table from high to low
sorted_Lib_ID_singlet_freq_table <- Lib_ID_singlet_freq_table %>%
  arrange(desc(Freq))
head(sorted_Lib_ID_singlet_freq_table)

# Remove the rows with 'Lib_ID_ratio_less_3'
filtered_Lib_ID_singlet_freq_table <- sorted_Lib_ID_singlet_freq_table %>%
  filter(Var1 != "Lib_ID_ratio_less_3")

# Plot a histogram using ggplot2
pdf(file.path(figures_dir, "L1_filtered_Lib_ID_singlet_freq_table.pdf"),width=8,height=5,paper='special')
ggplot(filtered_Lib_ID_singlet_freq_table, aes(x = reorder(Var1, -Freq), y = Freq)) +
  geom_bar(stat = "identity") +
  xlab("Barcode ID") +
  ylab("Frequency") +
  ggtitle("Frequency of Lib_ID Barcode") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
dev.off()

filtered_Lib_ID_singlet_freq_table_above3 <- sorted_Lib_ID_singlet_freq_table %>%
  filter(Var1 != "Lib_ID_ratio_less_3" & Freq > 3 )

pdf(file.path(figures_dir, "L1_filtered_Lib_ID_singlet_freqabove3_table.pdf"),width=6,height=5,paper='special')
ggplot(filtered_Lib_ID_singlet_freq_table_above3, aes(x = reorder(Var1, -Freq), y = Freq)) +
  geom_bar(stat = "identity") +
  xlab("Barcode ID") +
  ylab("Frequency") +
  ggtitle("Frequency of Lib_ID Barcode (Freq >3) ") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
dev.off()


# ==== Merge LARRY / Lib_ID assignment with L1.singlet seurat obj ======
## merge with L1.singlet with new assay: LARRY and Lib_ID

m <- L1.singlet # m is the obj to hold an obj with merged meta.data 
meta.m <- m@meta.data

# add LARRY assay to m (expression table) ====

LARRY_sparse_matrix[1:5,1:6]
dim(LARRY_sparse_matrix)
Lib_ID_sparse_matrix[1:5,1:6]
dim(Lib_ID_sparse_matrix)

# Ensure that the cell barcodes match between m and seurat_obj
common_cells <- intersect(rownames(m@meta.data), colnames(LARRY_sparse_matrix))

# Subset the counts matrix to include only the common cells
LARRY_assay_counts <- LARRY_sparse_matrix[, common_cells]
LARRY_assay_counts[1:5,1:6] 
dim(LARRY_assay_counts)
dim(m@assays$RNA$counts)

# pull the selected BCs used for BC assignment
filtered_LARRY_BC <- rownames(L1.LARRY@assays$LARRY)
row_names_LARRY <- rownames(LARRY_assay_counts)
head(row_names_LARRY)
head(filtered_LARRY_BC)
filtered_LARRY_BC_adjusted <- gsub("-", "_", filtered_LARRY_BC)

filtered_LARRY <- LARRY_assay_counts[filtered_LARRY_BC_adjusted, , drop = FALSE]

dim(filtered_LARRY)
filtered_LARRY[1:5,1:6]

# Create a new assay in the existing m Seurat object with the matched cells
m[["LARRY"]] <- CreateAssayObject(counts = filtered_LARRY)


# === add Lib_ID assay to m (expression table) ====
Lib_ID_sparse_matrix[1:5,1:6]
dim(Lib_ID_sparse_matrix)

# Ensure that the cell barcodes match between m and seurat_obj
common_cells_LibID <- intersect(rownames(m@meta.data), colnames(Lib_ID_sparse_matrix))

# Subset the counts matrix to include only the common cells
LibID_assay_counts <- Lib_ID_sparse_matrix[, common_cells]
LibID_assay_counts[1:5,1:6] 
dim(LibID_assay_counts)
dim(m@assays$RNA$counts)

# pull the selected BCs used for BC assignment
filtered_Lib_ID_BC <- rownames(L1.LARRY@assays$Lib_ID)
row_names_Lib_ID_BC <- rownames(LibID_assay_counts)
head(row_names_Lib_ID_BC)
head(filtered_Lib_ID_BC)

# Recode the barcodes based on the mapping
filtered_Lib_ID_BC <- sapply(filtered_Lib_ID_BC, function(bc) {
  if (bc %in% names(barcode_mapping)) {
    return(barcode_mapping[[bc]])
  } else {
    return(bc)
  }
})

# Ensure the row names of Lib_ID_assay_counts match the recoded barcodes

# Verify that all recoded barcodes exist in the row names of Lib_ID_sparse_matrix
matching_indices <- match(filtered_Lib_ID_BC, row_names_Lib_ID_BC, nomatch = 0)

# Print the matched indices for debugging purposes
print(matching_indices)


# Filter only the matched indices to avoid subscript out of bounds error
filtered_Lib_ID <- LibID_assay_counts[filtered_Lib_ID_BC[matching_indices > 0], , drop = FALSE]

# Verify the result
print(dim(filtered_Lib_ID))
print(head(filtered_Lib_ID))

# Create a new assay in the existing m Seurat object with the matched cells
m[["Lib_ID"]] <- CreateAssayObject(counts = filtered_Lib_ID)


# ===== consolidate LARRY Lib_ID assignment to mRNA singlet obj "m" =====
meta.m <- m@meta.data
colnames(m@meta.data)
m@meta.data$nCount_LARRY <- NULL
m@meta.data$nFeature_LARRY <- NULL
m@meta.data$nCount_Lib_ID <- NULL
m@meta.data$nFeature_Lib_ID <- NULL
meta.m <- m@meta.data
colnames(meta.m)
colnames(meta.L1.LARRY)

c <- intersect(row.names(meta.L1.LARRY), row.names(meta.m))

# Merge the LARRY Lib_ID assignment with the L1.singlet data frame using a left join
merged_df <- merge(meta.m, meta.L1.LARRY, by = "row.names", all.x = TRUE)
head(merged_df)

row.names(merged_df) <- merged_df$Row.names
merged_df$Row.names <-NULL
merged_df$cell_names <-NULL

merged_df <- merged_df %>%
  mutate(
    LARRY_first_bc = if_else(LARRY_ratio < 2, "LARRY_ratio_less 2", LARRY_first_bc),
    LARRY_first_bc = if_else(is.na(LARRY_first_bc), "not_detected", LARRY_first_bc),
  )

merged_df <- merged_df %>%
  mutate(
    LARRY_status = if_else(LARRY_first_bc != "not_detected" & LARRY_first_bc != "LARRY_ratio_less 2" , "LARRY_detected", "LARRY_not_detected")
  )
table(merged_df$LARRY_first_bc)
table(merged_df$LARRY_status)

merged_df <- merged_df %>%
  mutate(
    LibID_first_bc = if_else(Lib_ID_ratio < 3, "Lib_ID_ratio_less_3", LibID_first_bc),
    LibID_first_bc = if_else(is.na(LibID_first_bc), "not_detected", LibID_first_bc),
  )

merged_df <- merged_df %>%
  mutate(
    Lib_ID_status = if_else(LibID_first_bc != "not_detected" & LibID_first_bc != "Lib_ID_ratio_less_3", "Lib_ID_detected", "Lib_ID_not_detected")
  )

table(merged_df$LibID_first_bc)
table(merged_df$Lib_ID_status)

# Recode first_bc based on the mapping
merged_df$LibID_first_bc <- sapply(merged_df$LibID_first_bc, function(bc) {
  if (bc %in% names(barcode_mapping)) {
    return(barcode_mapping[[bc]])
  } else {
    return(bc)
  }
})
table(merged_df$LibID_first_bc)


# Display the merged data frame. This will used for further integration
head(merged_df)

# Validate the assignment accuracy across HTO_classification groups

LARRY_assignment_result <- merged_df %>%
  filter(HTO_classification %in% c("M-HTO-3", "M-HTO-4", "M-HTO-5")) %>%
  group_by(HTO_classification) %>%
  summarise(
    total = n(),
    detected = sum(LARRY_first_bc != "LARRY_ratio_less 2" & LARRY_first_bc != "not_detected")
  ) %>%
  mutate(
    percent_detected = (detected / total) * 100
  )

LARRY_assignment_result

# ====  plot assigned LARRY BC =====

# Filter the dataframe to exclude "not_detected", "LARRY ratio less 2", and NA values in LARRY_first_bc
filtered_df <- merged_df %>%
  filter(!is.na(LARRY_first_bc) & LARRY_first_bc != "not_detected" & LARRY_first_bc != "LARRY_ratio_less 2")

# Calculate frequencies
freq_table <- filtered_df %>%
  count(LARRY_first_bc) %>%
  arrange(desc(n))

# Reorder LARRY_first_bc factor levels based on frequencies
filtered_df$LARRY_first_bc <- factor(filtered_df$LARRY_first_bc, levels = freq_table$LARRY_first_bc)

# Create the frequency plot with ordered LARRY_first_bc
pdf(file.path(figures_dir, "L1_Assigned_LARRY_BC_freq_c2b2l4_N.pdf"), width=15,height=5,paper='special')
ggplot(filtered_df, aes(y = LARRY_first_bc)) +
  geom_bar() +
  labs(title = "Frequency of assigned LARRY_first_bc values",
       y = "LARRY_first_bc",
       x = "Frequency") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip()  # Rotate the plot 90 degrees
dev.off()

# ====  plot assigned Lib_ID BC =====

# clean up Lib-ID 
table(merged_df$LibID_first_bc)

# Ensure the column is character
merged_df$LibID_first_bc <- as.character(merged_df$LibID_first_bc)

# Recode the values
merged_df$LibID_first_bc <- ifelse(grepl("^R1", merged_df$LibID_first_bc), 
                                   merged_df$LibID_first_bc, 
                                   "not_detected")

# Optionally convert back to factor
merged_df$LibID_first_bc <- factor(merged_df$LibID_first_bc)

# Verify the changes
table(merged_df$LibID_first_bc)

# Filter the dataframe to exclude "not_detected", "Lib_ID_ratio_less_3", and NA values in Lib_ID_first_bc
filtered_Lib_ID_df <- merged_df %>%
  filter(!is.na(LibID_first_bc) & LibID_first_bc != "not_detected" & LibID_first_bc != "Lib_ID_ratio_less_3")

# Calculate frequencies
freq_table <- filtered_Lib_ID_df %>%
  count(LibID_first_bc) %>%
  arrange(desc(n))

# Reorder Lib_ID_first_bc factor levels based on frequencies
filtered_Lib_ID_df$LibID_first_bc <- factor(filtered_Lib_ID_df$LibID_first_bc, levels = freq_table$LibID_first_bc)

# Create the frequency plot with ordered Lib_ID_first_bc
pdf(file.path(figures_dir, "L1_Assigned_Lib_ID_BC_freq_c2b2l4_N.pdf"), width=6,height=5,paper='special')
ggplot(filtered_Lib_ID_df, aes(y = LibID_first_bc)) +
  geom_bar() +
  labs(title = "Frequency of assigned Lib_ID_first_bc values",
       y = "LibID_first_bc",
       x = "Frequency") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip()  # Rotate the plot 90 degrees
dev.off()


# save meta.data table
write.csv(merged_df, file = "./DATA/RDS/meta_merged_df.Z_L1_c2b2l4_N.csv")

# write back to m
m@meta.data <- merged_df
saveRDS(m, file = "./DATA/RDS/L1.singlet_post_BC_assignement.rds")


# ==== Run basic Seruat to check the assignment =====
# Visualize QC metrics as a violin plot
df <- m

set.seed(1)
df <- SCTransform(df, assay = "RNA", vars.to.regress = "percent.mt", verbose = TRUE)
df <- RunPCA(df, verbose = FALSE)
df <- RunUMAP(df, dims = 1:30, verbose = FALSE)
df <- FindNeighbors(df, dims = 1:30, verbose = FALSE)
df <- FindClusters(df, verbose = FALSE, resolution =1)

meta.df <- df@meta.data

pdf(file.path(figures_dir, "L1_UMAP_HTO.pdf"),width=15,height=5,paper='special')
DimPlot(df, split.by = "HTO_classification")
dev.off()

DimPlot(df, split.by = "HTO_classification")
DimPlot(df, group.by = "LARRY_status")

pdf(file.path(figures_dir, "L1_UMAP_LARRY_status.pdf"),width=10,height=5,paper='special')
DimPlot(df, split.by = "LARRY_status")
dev.off()

pdf(file.path(figures_dir, "L1_UMAP_Lib_ID_status.pdf"),width=10,height=5,paper='special')
DimPlot(df, split.by = "Lib_ID_status")
dev.off()

pdf(file.path(figures_dir, "L1_UMAP_Lib_ID_split.pdf"),width=25,height=5,paper='special')
DimPlot(df, split.by = "LibID_first_bc")
dev.off()

df.markers <- FindAllMarkers(df, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
top10 <- df.markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC)
top50 <- df.markers %>% group_by(cluster) %>% top_n(n = 50, wt = avg_log2FC)
DefaultAssay(df) <- "SCT"
Idents(df) <- "seurat_clusters"

pdf(file.path(figures_dir, "L1_Heatmap.pdf"),width=20,height=20,paper='special')
DoHeatmap(df, features = top10$gene) + scale_fill_gradientn(colors = c("blue", "white", "red")) 
dev.off()

pdf(file.path(figures_dir, "L1_Barplot_LARRY_status.pdf"),width=5,height=5,paper='special')
ggplot(df@meta.data, aes(x=LARRY_status, fill=seurat_clusters)) + geom_bar(position = "fill") + theme_classic()
dev.off()

pdf(file.path(figures_dir, "L1_VlnPlot_Mki67LARRY_status.pdf"),width=5,height=5,paper='special')
VlnPlot(df, features = "Mki67", group.by = "LARRY_status" )
dev.off()

DimPlot(df, split.by = "LARRY_status")
FeaturePlot(df, features = "Mki67")
FeaturePlot(df, features = "Melk")
FeaturePlot(df, features = "Sox6")

pdf(file.path(figures_dir, "Featureplot_BC-4.pdf"),width=6,height=6,paper='special')
FeaturePlot(df, features = "BC-4")
dev.off()

VlnPlot(df, features = "BC-4", group.by = "LARRY_status" )
VlnPlot(df, features = "BC-6", group.by = "LARRY_status" )

# save object for next step 
saveRDS(df, file = "./DATA/RDS/L1.singlet_post_BC_assignement_UMAP.rds")

